# Ystok-FFC
Foreign Function Compatibility layer

<p>Ystok-FFC — это небольшая библитека на языке Коммон Лисп для вызова внешних функций (foreign function interface, FFI). Под внешними подразумеваются функции, написанные на других языках программирования, обычно на С, откомпилированные и хранящиеся в виде динамически подключаемых библиотек (DLL).</p>

<p>Традиционно, каждая Лисп-система включают собственный FFI-пакет, не совместимый с другими реализациями Коммон Лисп. Использование Ystok-FFC делает исходный код легко переносимым, ибо обращения к внешним функциям происходят через одинаковый программный интрерфейс.</p>

<p>Ystok-FFC состоит из вспомогательных функций и макросов для:
<ul>
<li>определения прототипов внешних функций, элементарных и структурных типов даннх;</li>
<li>вызова внешних функций;</li>
<li>выделения памяти и работы с указателями на низком уровне;</li>
<li>динамического подключения библиотек.</li></p>
<br>

<p><b>Архитектурные принципы</b>
<ul>
<li>"Канонические" спецификации внешних типов данных Ystok-FFC — такие же, как в LispWorks. Синтаксис некоторых макросов и функций также позаимствованы из пакета fli системы LispWorks.</li>
<li>Для многих операций Ystok-FFC предусматривает более короткие имена, нежели пакет fli LispWorks.</li>
<li>Спецификации внешнего формата (кодировки букв) не унифицированы, а в точности такие, какие заложены в Лисп-систему, на которой будет компилироваться исходный код, например, LispWorks или SBCL.</li>
UTF-8 поддерживается всеми функциями, кроме %cstring-length, которая не экспортирована.<br>
<li>Хотя вызов внешней функции — самая распространённая точка перекодировки букв, желательно избегать перекодировки вообще. Для этого следует выбирать такую версию иноязычного модуля, который использует ту же внутреннюю кодировку, что Лисп-система.</li>
<li>В описании формальных параметров вызываемых функций строкового типа предпочитаются бестиповые ("пустые", void) указатели, а не типизированные.<br>
Это объясняется тем, что в SBCL sb-alien:make-alien-string всегда возвращает<br>
#<SB-ALIEN-INTERNALS:ALIEN-VALUE :SAP # :TYPE (* (SIGNED 8))>,<br>
даже если указана 16-битная кодировка, например :UCS-2LE.<br>
<li>Для SBCL мы используем типизированные указатели alien-value, а не бестиповые (System Area Pointer, SAP), в отличии от CFFI.</li>
</p>



<p><b>Ограничения</b></p>

<p>Текущая версия не поддерживает обратные вызовы из внешнего модуля в Лисп (foreign callables, callbacks).</p>

<p>Ystok-FFC не претендует на всесторонний охват всех возможностей, встречающихся в современных реализациях Коммон Лисп. Модуль предназначен лишь для наиболее популярных платформ и поддерживает функции, которые оказались полезными в наших проектах.</p>


<p><b>Платформы</b></p>

<p>Модуль Ystok-FFC тестировался на следующих реализациях Common Lisp:
<ul>
<li>LispWorks 4.4 и 6.1,</li>
<li>SBCL 1.0.55 для Windows.</li></p>
    
<p>Cодержит файлы определения систем:
<ul>
<li>yffc.asd для ASDlite/ASDF,</li>
<li>defsys.lisp для the LispWorks.</li></p>
