# Ystok-FFC

Foreign Function Compatibility layer


Ystok-FFC — это небольшая библитека на языке Коммон Лисп для вызова внешних функций (foreign function interface, FFI). Под внешними подразумеваются функции, написанные на других языках программирования, обычно на С, откомпилированные и хранящиеся в виде динамически подключаемых библиотек (DLL).

Традиционно, каждая Лисп-система включают собственный FFI-пакет, не совместимый с другими реализациями Коммон Лисп. Использование Ystok-FFC делает исходный код легко переносимым, ибо обращения к внешним функциям происходят через одинаковый программный интрерфейс.

Ystok-FFC состоит из вспомогательных функций и макросов для:
* определения прототипов внешних функций, элементарных и структурных типов даннх;
* вызова внешних функций;
* выделения памяти и работы с указателями на низком уровне;
* динамического подключения библиотек.

Архитектурные принципы
----------------------

* "Канонические" спецификации внешних типов данных Ystok-FFC — такие же, как в LispWorks. Синтаксис некоторых макросов и функций также позаимствованы из пакета fli системы LispWorks.
* Для многих операций Ystok-FFC предусматривает более короткие имена, нежели пакет fli LispWorks.
* Спецификации внешнего формата (кодировки букв) не унифицированы, а в точности такие, какие заложены в Лисп-систему, на которой будет компилироваться исходный код, например, LispWorks или SBCL. :UTF-8 поддерживается всеми функциями, кроме %cstring-length, которая не экспортирована.
* Хотя вызов внешней функции — самая распространённая точка перекодировки букв, желательно избегать перекодировки вообще. Для этого следует выбирать такую версию иноязычного модуля, который использует ту же внутреннюю кодировку, что Лисп-система.
* В описании формальных параметров вызываемых функций строкового типа предпочитаются бестиповые ("пустые", void) указатели, а не типизированные. Это объясняется тем, что в SBCL <code>sb-alien:make-alien-string</code> всегда возвращает <code>#SB-ALIEN-INTERNALS:ALIEN-VALUE :SAP # :TYPE (* (SIGNED 8))</code> даже если указана 16-битная кодировка, например <code>:UCS-2LE</code>.
* Для SBCL мы используем типизированные указатели alien-value, а не бестиповые (System Area Pointer, SAP), в отличии от CFFI.


Ограничения
-----------

Текущая версия не поддерживает обратные вызовы из внешнего модуля в Лисп (foreign callables, callbacks).

Ystok-FFC не претендует на всесторонний охват всех возможностей, встречающихся в современных реализациях Коммон Лисп. Модуль предназначен лишь для наиболее популярных платформ и поддерживает функции, которые оказались полезными в наших проектах.


Платформы
---------

Модуль Ystok-FFC тестировался на следующих реализациях Common Lisp
* LispWorks 4.4 и 6.1
* SBCL 1.0.55 для Windows.
    
Cодержит файлы определения систем
* yffc.asd для ASDlite/ASDF
* defsys.lisp для the LispWorks.

<i>Sources [http://ystok.ru/](http://lisp.ystok.ru/ru/yffc.html)</i>
